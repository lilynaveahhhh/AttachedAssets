name: Secret Rotation

on:
  schedule:
    - cron: '0 0 1 * *'  # Run monthly
  workflow_dispatch:      # Allow manual trigger

permissions:
  id-token: write
  contents: read

jobs:
  rotate-secrets:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Rotate AWS IAM User Access Keys
        run: |
          # Create new access key
          NEW_KEY=$(aws iam create-access-key --user-name github-actions-nimbus)
          ACCESS_KEY_ID=$(echo $NEW_KEY | jq -r '.AccessKey.AccessKeyId')
          SECRET_KEY=$(echo $NEW_KEY | jq -r '.AccessKey.SecretAccessKey')
          
          # Update GitHub Secrets
          gh secret set AWS_ACCESS_KEY_ID --body="$ACCESS_KEY_ID"
          gh secret set AWS_SECRET_ACCESS_KEY --body="$SECRET_KEY"
          
          # Wait for secrets to propagate
          sleep 30
          
          # Delete old access key
          OLD_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}"
          aws iam delete-access-key --user-name github-actions-nimbus --access-key-id "$OLD_KEY_ID"
        env:
          GH_TOKEN: ${{ secrets.GH_ADMIN_TOKEN }}

      - name: Verify New Credentials
        run: |
          aws sts get-caller-identity
          
      - name: Notify on Failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Secret Rotation Failed',
              body: 'Secret rotation workflow failed. Manual intervention required.',
              labels: ['security', 'high-priority']
            });